<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo Explorer Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Screen 0: Loading -->
    <div id="loading-screen" class="screen">
        <h2>Finding an interesting place...</h2>
    </div>

    <!-- Screen 1: Start Menu -->
    <div id="start-screen" class="screen active">
        <h1>Geo Explorer</h1>
        <button id="start-btn" class="action-button">Start Game</button>
        <button id="settings-btn" class="secondary-button">Settings</button>
    </div>

    <!-- Screen 2: Settings -->
    <div id="settings-screen" class="screen">
        <h2>Game Settings</h2>
        
        <div class="settings-section">
            <h3>Round Timer:</h3>
            <div class="radio-group">
                <label><input type="radio" name="timer-setting" value="15"> 15 sec</label>
                <label><input type="radio" name="timer-setting" value="30"> 30 sec</label>
                <label><input type="radio" name="timer-setting" value="60" checked> 60 sec</label>
                <label><input type="radio" name="timer-setting" value="100"> 100 sec</label>
            </div>
        </div>

        <div class="settings-section">
            <h3>Search Zones:</h3>
            <div id="zone-checkboxes" class="checkbox-group"></div>
        </div>

        <button id="save-settings-btn" class="action-button">Save</button>
        <button id="back-to-main-btn" class="secondary-button">Back to Menu</button>
    </div>

    <!-- Screen 3: Gameplay -->
    <div id="game-screen" class="screen">
        <div id="street-view"></div>
        <div id="game-ui">
            <p>Time: <span id="timer">100</span>s</p>
            <p>Moves: <span id="steps">500</span></p>
        </div>
        <button id="quit-game-btn" class="quit-button">Main Menu</button>
        <button id="guess-now-btn" class="action-button">Guess!</button>
    </div>
    
    <!-- Screen 4: Guessing Map -->
    <div id="guess-screen" class="screen">
        <h2>Where do you think you are?</h2>
        <div id="guess-map"></div>
        <button id="submit-guess-btn" class="action-button" style="margin-top: 20px;">Confirm Guess</button>
    </div>

    <!-- Screen 5: Results -->
    <div id="result-screen" class="screen">
        <h2>Round Complete!</h2>
        <p>Distance: <span id="distance-result"></span> km</p>
        <p>Round Score: <span id="score-result"></span></p>

        <!-- NEW: Location Name Display (Moved here) -->
        <div id="location-info">
            <div>
                <strong>Target Location:</strong>
                <span id="actual-coords">Loading...</span>
            </div>
            <div>
                <strong>Your Guess:</strong>
                <span id="guess-coords">Loading...</span>
            </div>
        </div>
      
        <div id="result-map"></div>

        <!-- NEW: Leaderboard and Session Summary Section -->
        <div class="session-summary-container">
            <h3>Session for <span id="player-name-display"></span></h3>
            <p style="font-size: 1.6em; font-weight: bold; color: #1DB954; margin: 10px 0;">
                Total Score: <span id="total-score-value">0</span>
            </p>
            
            <h4 style="margin-top: 20px;">Round History</h4>
            <ul id="leaderboard-list">
                <!-- Leaderboard items will be added here by JavaScript -->
            </ul>
        </div>
    
        <button id="play-again-btn" class="action-button">Play Another Round</button>
        <button id="end-session-btn" class="secondary-button">End Session & Return to Menu</button>
    </div>
  
    <!-- --- DYNAMIC SCRIPT LOADING --- -->
    <script src="apiKey.js"></script>
    <script src="config.js"></script>
    <script src="game-test.js"></script>
    <script>
      // This function injects the Google Maps script into the page with a given key.
      function initializeMapScript(apiKey) {
        if (!apiKey) {
          console.error("API Key is missing. Cannot load map.");
          document.body.innerHTML = '<h1>Error: API Key is missing.</h1><p>Site owner: Please configure the GOOGLE_API_KEY environment variable in Netlify.</p>';
          return;
        }
        const script = document.createElement('script');
        // 'initGame' is the callback function defined in game-test.js
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry&callback=initGame`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }

      // This function determines which API key to use.
      async function loadApiAndInitialize() {
        try {
          // 1. Try to fetch the key from our Netlify function (for production)
          const response = await fetch('/.netlify/functions/get-key');
          if (!response.ok) {
            // If the function call fails, trigger the catch block to use the local key.
            throw new Error(`Netlify function failed with status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Success! Using API key from Netlify function.");
          initializeMapScript(data.apiKey);
        } catch (error) {
          // 2. If fetching fails, fall back to the local key (for local development)
          console.warn("Could not fetch key from Netlify. This is normal for local development. Falling back to apiKey.js.");
          if (typeof GOOGLE_API_KEY !== 'undefined') {
            initializeMapScript(GOOGLE_API_KEY);
          } else {
            console.error("Local GOOGLE_API_KEY not found in apiKey.js.");
            document.body.innerHTML = '<h1>Error: Local API Key is not defined.</h1>';
          }
        }
      }

      // Start the process
      loadApiAndInitialize();
    </script>

</body>
</html>